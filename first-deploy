#!/usr/bin/bash
umask 077
set -euo pipefail

# RÃ©cupÃ©ration de l'utilisateur courant
CURRENT_USER=$(whoami)

# Extraction du nom du projet
PROJECT_NAME=$(echo "$CURRENT_USER" | grep -oP '^lx-\K.*' || echo "")

# VÃ©rification que le nom du projet a bien Ã©tÃ© trouvÃ©
if [[ -z "$PROJECT_NAME" ]]; then
    echo "Erreur: Le nom d'utilisateur ne commence pas par 'lx-'" >&2
    exit 1
fi

# Construction du chemin du projet
PROJECT_DIR="/home/$CURRENT_USER/$PROJECT_NAME"

# VÃ©rification que le rÃ©pertoire existe
if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "Erreur: Le rÃ©pertoire $PROJECT_DIR n'existe pas" >&2
    exit 1
fi

# VÃ©rification que npm est installÃ©
if ! command -v npm &> /dev/null; then
    echo "Erreur: npm n'est pas installÃ©" >&2
    exit 1
fi

# VÃ©rification que pm2 est installÃ©
if ! command -v pm2 &> /dev/null; then
    echo "Erreur: pm2 n'est pas installÃ©" >&2
    exit 1
fi

# VÃ©rification que ecosystem.config.js existe
if [[ ! -f "$PROJECT_DIR/ecosystem.config.js" ]]; then
    echo "Erreur: ecosystem.config.js n'existe pas dans $PROJECT_DIR" >&2
    exit 1
fi

# Changement de rÃ©pertoire
cd "$PROJECT_DIR"
echo "DÃ©ploiement du projet dans $PROJECT_DIR..."

# Installation des dÃ©pendances
echo "Installation des dÃ©pendances npm..."
npm install --production

# Build du projet (correction: npm run build)
echo "Build du projet..."
npm run build

# ArrÃªt des processus PM2 existants pour ce projet (si prÃ©sents)
echo "VÃ©rification des processus PM2 existants..."
pm2 delete all 2>/dev/null || true

# DÃ©marrage de l'application avec PM2
echo "DÃ©marrage de l'application avec PM2..."
pm2 start ecosystem.config.js

# Sauvegarde de la configuration PM2
echo "Sauvegarde de la configuration PM2..."
pm2 save

# Affichage du statut
echo ""
echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
echo ""
pm2 status

echo ""
echo "ðŸ“‹ Commandes utiles :"
echo "  - Voir les logs : pm2 logs"
echo "  - RedÃ©marrer : pm2 restart all"
echo "  - Statut : pm2 status"
echo "  - Monitoring : pm2 monit"

exit 0